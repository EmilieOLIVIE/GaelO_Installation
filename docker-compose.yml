version: "2"
#if needed to map the orthancPACS to a different hard disk device (after mounting it in path)
# volumes: ["/home/petctviewer/orthanc:/var/lib/orthanc/db:Z"]
services:
    gaelo:
        image: salimkanoun/gaelo
        container_name: gaelo
        depends_on: [indexgaelo, traefik]
        restart: unless-stopped
        labels:
          - "traefik.enable=true"
          - "traefik.http.middlewares.gaelo-https.redirectscheme.scheme=https"
          - "traefik.http.routers.gaelo-http.entrypoints=web"
          - "traefik.http.routers.gaelo-http.rule=Host(`localhost`)"
          - "traefik.http.routers.gaelo-http.middlewares=gaelo-https@docker"
          - "traefik.http.routers.gaelo.entrypoints=web-secure"
          - "traefik.http.routers.gaelo.rule=Host(`localhost`)"
          - "traefik.http.routers.gaelo.tls=true"
          - "traefik.http.routers.gaelo.tls.certresolver=default"
        volumes: ["gaelo:/gaelo/data:Z"]
    orthancexposed:
        build: orthancexposed
        container_name: orthancexposed
        restart: unless-stopped
        volumes: ["storageexposed:/var/lib/orthanc/db:Z"]
        environment:
            AC_REGISTERED_USERS: "{\"internal\":\"GaelO\",\"external\":\"GaelO\"}"
            TRANSFERS_BUNDLE_DEFAULTS: "true"
            NAME: OrthancExposed
            AC_AUTHENTICATION_ENABLED : "true"
            PEERS: |
                {
                    "OrthancPacs": ["http://orthancpacs:8042/", "GaelO", "GaelO"]
                }
    orthancpacs:
        build: orthancpacs
        container_name: orthancpacs
        depends_on: [indexorthanc]
        restart: unless-stopped
        volumes: ["storagepacs:/var/lib/orthanc/db:Z"]
        environment:
            AC_REGISTERED_USERS: "{\"GaelO\":\"GaelO\",\"dicomWeb\":\"dicomWeb\"}"
            DW_ENABLED: "true"
            TRANSFERS_BUNDLE_DEFAULTS: "true"
            AC_AUTHENTICATION_ENABLED : "true"
            NAME: OrthancPacs 
            MYSQL_HOST: indexorthanc
            MYSQL_USER: orthancPacs
            MYSQL_DB: orthancPacs
            MYSQL_PASSWORD: sassa
    indexorthanc:
            image: mysql:8.0
            container_name: indexorthanc
            command: [mysqld, --default-authentication-plugin=mysql_native_password, --log-bin-trust-function-creators=1]
            volumes: ["index:/var/lib/mysql:Z"]
            environment:
                    MYSQL_ENABLED: "true" 
                    MYSQL_PASSWORD: sassa
                    MYSQL_USER: orthancPacs
                    MYSQL_DATABASE: orthancPacs
                    MYSQL_ROOT_PASSWORD: foo-root
            restart: unless-stopped
    indexgaelo:
        image: mysql:8.0
        container_name: indexgaelo
        command: [mysqld, --default-authentication-plugin=mysql_native_password, --log-bin-trust-function-creators=1]
        volumes: ["indexgaelo:/var/lib/mysql:Z"]
        environment:
                MYSQL_ENABLED: "true" 
                MYSQL_PASSWORD: gaelo
                MYSQL_USER: gaelo
                MYSQL_DATABASE: gaelo
                MYSQL_ROOT_PASSWORD: foo-root
        restart: unless-stopped
    traefik:
        image: traefik:2.1
        container_name: "traefik"
        command: 
            --api.insecure=true 
            --providers.docker
            --entrypoints.web.address=:80
            --entrypoints.web-secure.address=:443
        ports:
            - "8082:80"
            - "443:443"
            - "8080:8080"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        restart: unless-stopped
   

volumes:
        storageexposed:
        storagepacs:
        index:
        gaelo:
        indexgaelo:
